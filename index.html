<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Smart Petit Train - Dahomey Discovery</title>
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <link rel="icon" type="image/png" href="assets/img/favicon.png" /> 

    <style>
        /* ========================================================= */
        /* CONFIGURATION G√âN√âRALE */
        /* ========================================================= */
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif; 
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        /* ========================================================= */
        /* 1. √âCRAN D'ACCUEIL */
        /* ========================================================= */
        #home-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('assets/img/Petit_train.jpg'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 100;
        }

        #home-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); 
            z-index: 1;
        }

        #home-content {
            position: relative;
            z-index: 2;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        #dahomey-logo-home {
            max-width: 180px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background: white;
            padding: 10px;
        }

        .home-title {
            color: white;
            font-size: 2em;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .circuit-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 8px solid transparent; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            text-align: left;
            width: 100%;
        }

        .circuit-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .circuit-card h3 { margin: 0; font-size: 1.2em; color: #333; }
        .circuit-card span { font-size: 0.9em; color: #666; }
        .chevron-icon { font-size: 1.5em; font-weight: bold; }

        #btn-start-day { border-left-color: #CC0000; }
        #btn-start-day .chevron-icon { color: #CC0000; }

        #btn-start-night { border-left-color: #DAA520; }
        #btn-start-night .chevron-icon { color: #DAA520; }

        /* Bouton Simulation */
        #btn-simulation {
            background-color: #2196F3; /* Bleu */
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
        }
        #btn-simulation:hover { background-color: #1976D2; }


        /* ========================================================= */
        /* 2. √âCRAN DE SUIVI (STYLE DASHBOARD MAP) */
        /* ========================================================= */
        #tracking-screen {
            display: none; 
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        #top-bar {
            height: 80px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
            flex-shrink: 0;
        }

        #top-logo { height: 50px; }

        .status-badge {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-badge.offline { background: #F44336; }
        .status-badge.simu { background: #2196F3; } 
        .status-badge.wake-lock-on { background: #8BC34A; } 

        #main-layout {
            flex-grow: 1;
            position: relative;
            display: flex;
        }

        #map { width: 100%; height: 100%; z-index: 1; }

        #info-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 999;
            border-top: 4px solid #993300;
        }

        /* --- IMAGE MONUMENT --- */
        #monument-image-container {
            display: none; /* Cach√© par d√©faut */
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #monument-image {
            width: 100%;
            height: auto;
            max-height: 200px; /* Limiter la taille sur mobile */
            object-fit: cover;
            transition: opacity 0.3s;
        }


        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 10px;
        }
        .info-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        #current-stop-label { font-size: 0.8em; color: #777; text-transform: uppercase; letter-spacing: 1px; }
        #current-stop-name { font-size: 1.8em; font-weight: 800; color: #CC0000; line-height: 1.1; }

        .secondary-info { font-size: 0.95em; color: #555; }
        .highlight-info { color: #DAA520; font-weight: bold; font-size: 1.1em; }

        #audio-status-bar {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #audio-feedback { margin: 0 0 10px 0; font-size: 0.9em; font-weight: 600; }
        
        /* --- BARRE DE PROGRESSION --- */
        #progress-container {
            width: 100%;
            height: 8px;
            background: #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: #CC0000;
            transition: width 0.1s linear;
        }


        #manual-controls { display: flex; gap: 10px; width: 100%; }
        #manual-controls button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: opacity 0.2s;
        }
        #btn-replay { background-color: #DAA520; color: #333; }
        #btn-stop { background-color: #CC0000; }
        #manual-controls button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- RESPONSIVE PC --- */
        @media (min-width: 900px) {
            #info-panel {
                bottom: auto;
                top: 20px;
                left: 20px;
                transform: none;
                width: 350px;
                max-height: calc(100% - 40px);
                overflow-y: auto;
            }
            #monument-image {
                max-height: 250px; 
            }
        }

    </style>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

    <div id="home-screen">
        <div id="home-overlay"></div> 
        
        <div id="home-content">
            <img src="assets/img/Dahomey_Discovery_Logo.jpg" alt="Logo Dahomey" id="dahomey-logo-home">
            
            <h1 class="home-title">Bienvenue, Op√©rateur</h1>

            <div id="btn-start-day" class="circuit-card" onclick="startCircuit('jour')">
                <div>
                    <h3>CIRCUIT JOUR ‚òÄÔ∏è</h3>
                    <span>D√©couverte historique & culturelle</span>
                </div>
                <div class="chevron-icon">‚û§</div>
            </div>

            <div id="btn-start-night" class="circuit-card" onclick="startCircuit('nuit')">
                <div>
                    <h3>CIRCUIT NUIT üåô</h3>
                    <span>Ambiance nocturne & lumi√®res</span>
                </div>
                <div class="chevron-icon">‚û§</div>
            </div>

            <button id="btn-simulation" onclick="startSimulation()">üéÆ TESTER EN SIMULATION (SANS GPS)</button>
        </div>
    </div>

    <div id="tracking-screen" style="display: none !important;"> 
        
        <div id="top-bar">
            <img src="assets/img/Dahomey_Discovery_Logo.jpg" alt="Logo Small" id="top-logo">
            <div id="circuit-info" style="font-weight:bold; color:#993300;">MODE: <span id="circuit-mode">---</span></div>
            <div id="gps-status" class="status-badge">üî¥ GPS OFF</div>
        </div>

        <div id="main-layout">
            <div id="map"></div>

            <div id="info-panel">
                
                <div id="monument-image-container">
                    <img id="monument-image" alt="Image du Monument" src="">
                </div>

                <div class="info-row" style="display:block;">
                    <div id="current-stop-label">Arr√™t Actuel</div>
                    <div id="current-stop-name">D√âBUT DE PARCOURS</div>
                </div>

                <div class="info-row">
                    <span class="secondary-info">Prochain :</span>
                    <span id="next-stop-name" style="font-weight:600;">---</span>
                </div>

                <div class="info-row">
                    <span class="secondary-info">Distance :</span>
                    <span id="distance-display" class="highlight-info">---</span>
                </div>

                <div id="audio-status-bar">
                    <div id="audio-feedback">Pr√™t pour le d√©part.</div>
                    
                    <div id="progress-container">
                        <div id="progress-bar"></div>
                    </div>

                    <div id="manual-controls">
                        <button id="btn-replay" disabled onclick="replayAudio()">üîÅ Rejouer</button>
                        <button id="btn-stop" disabled onclick="stopAudio()">üõë Stop</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <script>
        // =========================================================
        // DONN√âES DU CIRCUIT JOUR (SANS PHOTOS)
        // =========================================================
        const CIRCUIT_JOUR_STOPS = [
            { id: 1, name: "D√©part", file: "depart_2.mp3", latitude: 6.352701574373512, longitude: 2.407548102091667, triggerRadius: 100, audioDuration: 31 },
            { id: 2, name: "Mur du Patrimoine", file: "mur_patrimoine_2.mp3", latitude: 6.350008082284632, longitude: 2.415699296052794, triggerRadius: 500, audioDuration: 31 },
            { id: 3, name: "Avenue Jean Paul II", file: "avenue_jean_paul_2.mp3", latitude: 6.352762241666526, longitude: 2.4201564243656684, triggerRadius: 500, audioDuration: 31 },
            { id: 4, name: "Place du Souvenir", file: "place_souvenir_2.mp3", latitude: 6.353965166963285, longitude: 2.404862680183919, triggerRadius: 400, audioDuration: 31 },
            { id: 5, name: "Place Bio Gu√©ra", file: "bio_guerra_2.mp3", latitude: 6.350322364770094, longitude: 2.3875428397110525, triggerRadius: 400, audioDuration: 31 },
            { id: 6, name: "H√¥tel Sofitel", file: "sofitel_2.mp3", latitude: 6.349740427997271, longitude: 2.3936832955293195, triggerRadius: 400, audioDuration: 53 },
            { id: 7, name: "Fin du Trajet", file: "fin_trajet_2.mp3", latitude: 6.352701574373512, longitude: 2.407548102091667, triggerRadius: 300, audioDuration: 41 }
        ];
        
        let CIRCUIT_NUIT_STOPS = []; 

        // --- VARIABLES D'√âTAT ---
        let currentCircuitData = null;
        let currentStopIndex = 0;
        let isAudioPlaying = false;
        let watchID = null; 
        let simulationInterval = null;
        let isSimulationMode = false;
        let progressInterval = null; 
        let wakeLock = null; 

        const audioPlayer = new Audio();
        let map = null;
        let trainMarker = null; 
        let stopMarker = null;  

        // --- √âL√âMENTS DOM ---
        const homeScreen = document.getElementById('home-screen');
        const trackingScreen = document.getElementById('tracking-screen');
        const gpsStatus = document.getElementById('gps-status');
        const currentStopName = document.getElementById('current-stop-name');
        const nextStopName = document.getElementById('next-stop-name');
        const audioFeedback = document.getElementById('audio-feedback');
        const distanceDisplay = document.getElementById('distance-display');
        const btnReplay = document.getElementById('btn-replay');
        const btnStop = document.getElementById('btn-stop');
        const progressBar = document.getElementById('progress-bar');

        // --- ICONES MAP ---
        const trainIcon = L.divIcon({
            className: 'custom-train-icon', 
            html: '<div style="font-size:40px; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));">üöÇ</div>', 
            iconSize: [50, 50], 
            iconAnchor: [25, 25]
        });

        // --- D√âBLOCAGE AUDIO & VERROUILLAGE √âCRAN ---

        function unlockAudio() {
            audioPlayer.src = ''; 
            audioPlayer.play().catch(() => {}); 
            audioPlayer.pause();
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    gpsStatus.classList.add('wake-lock-on');
                    console.log('Wake Lock activ√©');
                } catch (err) {
                    console.error('Erreur Wake Lock:', err.name, err.message);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                    gpsStatus.classList.remove('wake-lock-on');
                });
            }
        }

        // --- LOGIQUE G√âN√âRALE ---

        function startCircuit(mode) {
            unlockAudio();
            requestWakeLock(); 
            isSimulationMode = false;
            initCircuit(mode);
            setTimeout(() => { startTracking(); }, 100);
        }

        function startSimulation() {
            unlockAudio();
            requestWakeLock(); 
            isSimulationMode = true;
            initCircuit('jour'); 
            
            document.getElementById('circuit-mode').textContent = "SIMULATION";
            gpsStatus.textContent = "üéÆ SIMULATION";
            gpsStatus.classList.add('simu');
            gpsStatus.classList.remove('offline');

            setTimeout(() => { runSimulationLoop(); }, 1000);
        }

        function initCircuit(mode) {
            currentCircuitData = (mode === 'jour') ? CIRCUIT_JOUR_STOPS : CIRCUIT_NUIT_STOPS;
            
            if (currentCircuitData.length === 0) {
                 alert("Erreur: Circuit vide."); return;
            }

            currentStopIndex = 0;
            homeScreen.style.display = 'none';
            trackingScreen.style.display = 'flex'; 
            
            document.getElementById('circuit-mode').textContent = mode.toUpperCase();
            currentStopName.textContent = "D√âBUT DE PARCOURS";
            nextStopName.textContent = currentCircuitData[currentStopIndex].name;
        }

        function initMap(lat, lon) {
            if (map !== null) map.remove();
            map = L.map('map').setView([lat, lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            trainMarker = L.marker([lat, lon], { icon: trainIcon }).addTo(map);
            updateNextStopMarker();
        }

        function updateNextStopMarker() {
            if (stopMarker) map.removeLayer(stopMarker);
            const nextStop = currentCircuitData[currentStopIndex];
            if (nextStop) {
                 stopMarker = L.marker([nextStop.latitude, nextStop.longitude], {
                    icon: L.divIcon({
                        className: '', 
                        html: '<div style="background: #CC0000; width: 15px; height: 15px; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                        iconAnchor: [10, 10]
                    }) 
                 }).addTo(map);
            }
        }

        function updateMap(lat, lon) {
            const newLatLng = new L.LatLng(lat, lon);
            if (trainMarker) trainMarker.setLatLng(newLatLng);
            if (map) map.setView(newLatLng, map.getZoom()); 
        }

        // --- BARRE DE PROGRESSION ---
        function startProgressTracking() {
            progressInterval = setInterval(() => {
                const duration = audioPlayer.duration;
                const currentTime = audioPlayer.currentTime;
                if (duration > 0 && currentTime >= 0) {
                    const percentage = (currentTime / duration) * 100;
                    progressBar.style.width = percentage + '%';
                }
            }, 100);
        }

        function stopProgressTracking() {
            clearInterval(progressInterval);
            progressBar.style.width = '0%';
        }

        // --- SUIVI GPS ---
        function startTracking() {
            if ('geolocation' in navigator) {
                gpsStatus.textContent = "üü° RECHERCHE...";
                watchID = navigator.geolocation.watchPosition(
                    (position) => {
                        gpsStatus.textContent = "üü¢ GPS ONLINE";
                        gpsStatus.classList.remove('offline');
                        if (map === null) initMap(position.coords.latitude, position.coords.longitude);
                        checkStopTrigger(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        gpsStatus.textContent = "üî¥ GPS OFF";
                        gpsStatus.classList.add('offline');
                        audioFeedback.textContent = "Erreur GPS : " + error.message;
                        if (map === null) initMap(6.366, 2.448); 
                    },
                    { enableHighAccuracy: true, maximumAge: 2000 }
                );
            } else { alert("GPS non support√©."); }
        }

        function runSimulationLoop() {
            let simLat = 6.3535; 
            let simLon = 2.4070;
            if (map === null) initMap(simLat, simLon);
            const stepSize = 0.00005; 

            simulationInterval = setInterval(() => {
                if (!currentCircuitData[currentStopIndex]) {
                    clearInterval(simulationInterval);
                    releaseWakeLock(); 
                    return;
                }
                const target = currentCircuitData[currentStopIndex];
                const dLat = target.latitude - simLat;
                const dLon = target.longitude - simLon;
                const dist = Math.sqrt(dLat*dLat + dLon*dLon);

                if (dist > 0.0001) {
                    simLat += (dLat / dist) * stepSize;
                    simLon += (dLon / dist) * stepSize;
                } 
                updateMap(simLat, simLon);
                checkStopTrigger(simLat, simLon);
            }, 100); 
        }

        // --- COEUR DU SYST√àME ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function checkStopTrigger(lat, lon) {
            const nextStop = currentCircuitData[currentStopIndex];

            if (!nextStop) {
                currentStopName.textContent = "TERMINUS";
                nextStopName.textContent = "---";
                distanceDisplay.textContent = "0 m";
                btnReplay.disabled = true; btnStop.disabled = true;
                if(watchID) navigator.geolocation.clearWatch(watchID);
                releaseWakeLock();
                return;
            }

            const dist = calculateDistance(lat, lon, nextStop.latitude, nextStop.longitude);
            distanceDisplay.textContent = Math.round(dist) + " m";

            if (isAudioPlaying) {
                 btnReplay.disabled = false; btnStop.disabled = false;
                 return;
            } else {
                 btnReplay.disabled = true; btnStop.disabled = false;
            }

            if (dist <= nextStop.triggerRadius && !isAudioPlaying) {
                playAudio(nextStop);
                isAudioPlaying = true;
                audioFeedback.textContent = `‚ñ∂Ô∏è LECTURE : ${nextStop.name}`;
                btnReplay.disabled = false; btnStop.disabled = false;
            }
        }

        function playAudio(stop) {
            // Utilisation du chemin standard assets/audio/
            audioPlayer.src = stop.file ? ('assets/audio/' + stop.file) : '';
            currentStopName.textContent = stop.name; 
            
            startProgressTracking();
            
            var playPromise = audioPlayer.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => { })
                .catch(error => {
                  console.error("Auto-play bloqu√© :", error);
                  audioFeedback.textContent = "‚ö†Ô∏è CLIQUEZ ICI POUR ACTIVER LE SON";
                  document.body.addEventListener('click', function unlock() {
                      audioPlayer.play();
                      document.body.removeEventListener('click', unlock);
                  }, { once: true });
                });
            }

            audioPlayer.onended = () => {
                isAudioPlaying = false;
                currentStopIndex++;
                updateNextStopMarker();
                stopProgressTracking();
                
                if (currentCircuitData[currentStopIndex]) {
                    nextStopName.textContent = currentCircuitData[currentStopIndex].name;
                    audioFeedback.textContent = "En route vers le prochain arr√™t...";
                } else {
                    nextStopName.textContent = "FIN";
                    audioFeedback.textContent = "Circuit termin√©. Bonne journ√©e !";
                    releaseWakeLock(); 
                }
                btnReplay.disabled = true; btnStop.disabled = true;
            };
        }

        function replayAudio() {
            const idx = isAudioPlaying ? currentStopIndex : (currentStopIndex > 0 ? currentStopIndex - 1 : 0);
            const stop = currentCircuitData[idx];
            if(stop) {
                audioPlayer.currentTime = 0;
                if(!isAudioPlaying) {
                    playAudio(stop); 
                    isAudioPlaying = true;
                    currentStopIndex = idx; 
                }
                audioFeedback.textContent = `üîÅ REPLAY : ${stop.name}`;
            }
        }

        function stopAudio() {
            if(isAudioPlaying) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isAudioPlaying = false;
                stopProgressTracking();
                audioFeedback.textContent = "üõë Arr√™t manuel.";
                btnReplay.disabled = true; btnStop.disabled = true;
            }
        }
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker enregistr√© !', reg))
            .catch(err => console.log('Erreur SW :', err));
        });
      }
    </script>
</body>
</html>