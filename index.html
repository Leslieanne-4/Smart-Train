<!DOCTYPE html>


<html lang="fr">


<head>


    <meta charset="UTF-8">


    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">


    <title>Smart Petit Train - Dahomey Discovery</title>


    <link rel="manifest" href="manifest.json">


    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' data: blob:;
        script-src 'self' 'unsafe-inline' https://unpkg.com;
        style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: blob: https://*.tile.openstreetmap.org;
        media-src 'self' assets/audio/;
        connect-src 'self' https://nominatim.openstreetmap.org ;
        ">



    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />


    <link rel="icon" type="image/png" href="assets/img/favicon.png" />




    <style>
   
        /* ========================================================= */
   
        /* CONFIGURATION G√âN√âRALE */
   
        /* ========================================================= */
   
        * { box-sizing: border-box; }


        html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden; /* Emp√™che le site de "sauter" vers le haut ou le bas */
    position: fixed;  /* Verrouille l'interface pour qu'elle ne bouge plus */
}


body {
    font-family: 'Times new roman', sans-serif;
    background-color: #f0f0f0;
}


       /* Emp√™che le zoom tactile accidentel et la s√©lection de texte */
       body {
    touch-action: none; /* Emp√™che le navigateur de zoomer/scroller la page enti√®re */
    user-select: none;  /* Emp√™che de s√©lectionner le texte en tapotant partout */
    /* ... vos autres styles body ... */
}


      /* ========================================================= */
        /* 1. √âCRAN D'ACCUEIL */
        /* ========================================================= */
        #home-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('assets/img/Petit_train.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 100;
        }
       
        @media (max-width: 768px) { /* Pour les √©crans de largeur inf√©rieure ou √©gale √† 768px */
    #home-screen {
        background-image: url('assets/img/Petit_train_mobile.jpg'); /* Version optimis√©e pour mobile */
        background-position: center bottom; /* Ou une autre position si l'image mobile est diff√©rente */
     }
    }
        #home-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1;
        }


        #home-content {
            position: relative;
            z-index: 2;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }


        #dahomey-logo-home {
            max-width: 180px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background: white;
            padding: 10px;
        }


        .home-title {
            color: rgb(255, 245, 217);
            font-size: 2em;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }


        .circuit-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 8px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            text-align: left;
            width: 100%;
        }


.dashboard {
    background-color: white;
    padding: 15px;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
    flex-shrink: 0; /* Emp√™che l'√©crasement vu dans ta vid√©o */
    z-index: 1000;
}
        .circuit-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }


        .circuit-card h3 { margin: 0; font-size: 1.2em; color: #333; }
        .circuit-card span { font-size: 0.9em; color: #666; }
        .chevron-icon { font-size: 1.5em; font-weight: bold; }


        #btn-start-day { border-left-color: #CC0000; }
        #btn-start-day .chevron-icon { color: #CC0000; }


        #btn-start-night { border-left-color: #DAA520; }
        #btn-start-night .chevron-icon { color: #DAA520; }


        /* Bouton Simulation */
        #btn-simulation {
            background-color: #2196F3; /* Bleu */
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
        }


        #btn-simulation:hover { background-color: #1976D2; }


        /* ========================================================= */
        /* 2. √âCRAN DE SUIVI (STYLE DASHBOARD MAP) */
        /* ========================================================= */


        #tracking-screen {
    display: none; /* Reste ainsi, le JS l'affichera au clic */
    flex-direction: column;
    height: 100vh;      /* Force l'√©cran √† faire la hauteur exacte du t√©l√©phone */
    width: 100vw;       /* Force la largeur exacte */
    margin: 0;
    padding: 0;
    overflow: hidden;   /* Interdit tout ce qui d√©passe de l'√©cran */
    position: fixed;    /* Bloque l'√©cran pour √©viter le "saut" au moment du zoom */
    top: 0;
    left: 0;
}


        #top-bar {
            height: 80px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
            flex-shrink: 0;
        }


        #top-logo { height: 50px; }


        .status-badge {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }


        .status-badge.offline { background: #F44336; }
        .status-badge.simu { background: #2196F3; }
        .status-badge.wake-lock-on { background: #8BC34A; }


        #main-layout {
            flex-grow: 1;
            position: relative;
            display: flex;
        }


        #map { width: 100%; height: 100%; z-index: 1; }


        /* ========================================= */
/* STYLE DU PANNEAU D'INFORMATION (UNIFI√â) */
/* ========================================= */


#info-panel {
    /* 1. ON BLOQUE LA POSITION POUR √âVITER LES SAUTS */
    position: fixed;      /* Fix√© par rapport √† l'√©cran, pas par rapport √† la carte */
    bottom: 0;
    left: 0;
    width: 100%;
   
    /* 2. ON UTILISE UNE HAUTEUR FIXE MAIS ON LE CACHE PLUS BAS */
    height: 60vh;         /* Il peut monter jusqu'√† 60% de l'√©cran */
    max-height: 500px;    /* S√©curit√© pour les grands √©crans */
   
    /* 3. DESIGN (On garde tes r√©glages) */
    background-color: white;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
    z-index: 9999;
    padding: 20px;
    overflow-y: auto;
   
    /* 4. LE SECRET ANTI-D√âFORMATION : LE TRANSFORM */
    transition: transform 0.3s ease-out; /* Beaucoup plus fluide que "height" */
    transform: translateY(70%); /* Par d√©faut, il d√©passe un peu en bas (le bouton DETAILS d√©passe) */
   
    /* Annule les styles PC */
    top: auto;
    right: auto;
}


/* 2. STYLE √âCRAN LARGE (PC) üíª */
@media (min-width: 900px) {
    #info-panel {
        /* On d√©colle du bas */
        bottom: auto;
       
        /* On place en HAUT √† DROITE */
        top: 100px;  
        right: 20px;
        left: auto;  
       
        /* Dimensions PC */
        width: 350px;
        height: auto;           /* La hauteur s'adapte au contenu */
        max-height: calc(100% - 120px); /* Ne d√©passe pas l'√©cran */
       
        /* Design PC "Flottant" */
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        border-radius: 20px;    /* Arrondi partout */
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: 1px solid rgba(0,0,0,0.05);
    }
}


        .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    /* On supprime la ligne pointill√©e moche */
    border-bottom: none;
    padding-bottom: 0;


        }
        .info-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }


        #current-stop-label {
    font-size: 0.75em;
    color: #888;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.5px; /* Espacement des lettres plus moderne */
    margin-bottom: 2px;
}


#current-stop-name {
    font-size: 1.6em; /* Un peu plus petit pour √™tre √©l√©gant */
    font-weight: 700;
    color: #222; /* Noir doux au lieu de rouge agressif */
    line-height: 1.2;
    margin-bottom: 15px; /* Espace apr√®s le gros titre */
}
        .secondary-info { font-size: 0.95em; color: #555; }
        .highlight-info { color: #DAA520; font-weight: bold; font-size: 1.1em; }


        #audio-status-bar {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            max-height: calc(100% - 100px); /* Laisse de la place pour le titre et les infos */
            overflow-y: auto; /* Important pour le d√©filement interne */
            display: flex;
            flex-direction: column;
            align-items: center;
        }


        #audio-feedback { margin: 0 0 10px 0; font-size: 0.9em; font-weight: 600; }


        /* --- BARRE DE PROGRESSION --- */
        #progress-container {
            width: 100%;
            height: 8px;
            background: #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }


        #progress-bar {
            height: 100%;
            width: 0%;
            background: #CC0000;
            transition: width 0.1s linear;
        }


        #manual-controls { display: flex; gap: 10px; width: 100%; }
        #manual-controls button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: opacity 0.2s;
        }
        /* Correction de la couleur du bouton replay pour qu'elle soit blanche */
        #btn-replay { background-color: #DAA520; color: white; }
        #btn-play-pause { background-color: #4CAF50; /* Vert pour Play */ }
        #btn-play-pause.paused { background-color: #FF9800; /* Orange pour Pause */ }
        #btn-stop { background-color: #CC0000; }
        #manual-controls button:disabled { opacity: 0.5; cursor: not-allowed; }


        /* Nouveau style pour le bouton d'activation audio */
    #btn-activate-audio {
        background-color: #007bff;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 5px;
        margin-top: 10px;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        display: none; /* Cach√© par d√©faut */
    }


/* --- STYLE DU NOUVEAU BOUTON TOGGLE --- */
#panel-toggle {
    text-align: center;
    padding: 8px;
    margin-bottom: 10px;
    background-color: #f8f9fa;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    color: #555;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}


/* --- CORRECTION DU PANNEAU MOBILE --- */
@media (max-width: 900px) {
    #info-panel {
        /* On fixe une hauteur initiale petite */
        height: 200px !important;
        transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Animation fluide */
        padding-top: 6px;
        z-index: 9999;
    }


    /* Quand on ajoute la classe 'open', le panneau grandit */
    #info-panel.open {
        height: 60% !important; /* Prend 60% de l'√©cran */
    }
}
</style>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


</head>
<body>


    <div id="home-screen">
        <div id="home-overlay"></div>
        <div id="home-content">
            <img src="assets/img/Dahomey_Discovery_Logo.jpg" alt="Logo Dahomey" id="dahomey-logo-home">
            <h1 class="home-title"> Bienvenue ! </h1>


            <div id="btn-start-day" class="circuit-card" onclick="startCircuit('jour')">
                <div>
                    <h3>CIRCUIT JOUR ‚òÄÔ∏è</h3>
                    <span>D√©couverte historique & culturelle</span>
                </div>
                <div class="chevron-icon">‚û§</div>
            </div>


            <div id="btn-start-night" class="circuit-card" onclick="startCircuit('nuit')">
                <div>
                    <h3>CIRCUIT NUIT üåô</h3>
                    <span>Ambiance nocturne & lumi√®res</span>
                </div>
                <div class="chevron-icon">‚û§</div>
            </div>


            <button id="btn-simulation" onclick="startSimulation()">üéÆ TESTER EN SIMULATION (SANS GPS)</button>
        </div>
    </div>


    <div id="tracking-screen" style="display: none !important;">
        <div id="top-bar">
    <button id="btn-back-home" style="
        background: none;
        border: none;
        font-size: 1.8em;
        color: #993300;
        cursor: pointer;
        padding: 0 10px;
    ">‚¨ÖÔ∏è</button> <img src="assets/img/Dahomey_Discovery_Logo.jpg" alt="Logo Small" id="top-logo">
    <div id="circuit-info" style="font-weight:bold; color:#993300;">MODE: <span id="circuit-mode">---</span></div>
    <div id="gps-status" class="status-badge">üî¥ GPS OFF</div>
</div>


        <div id="main-layout">
            <div id="map"></div>
        </div>


       <div id="info-panel" style="transform: translateY(70%);">
    <div id="panel-toggle" onclick="togglePanel()">
        <span id="toggle-icon">‚¨ÜÔ∏è</span> D√âTAILS
    </div>


    <div class="info-row" style="display:block;">
    <div id="current-stop-label">Arr√™t Actuel</div>
    <div id="current-stop-name">---</div>
</div>


            <div class="info-row">
                <span class="secondary-info">Prochain :</span>
                <span id="next-stop-name" style="font-weight:600;">---</span>
            </div>


            <div class="info-row">
                <span class="secondary-info">Distance :</span>
                <span id="distance-display" class="highlight-info">---</span>
            </div>


            <div id="audio-status-bar">
                <div id="audio-feedback">Pr√™t pour le d√©part.</div>
               
                <div id="progress-container">
                    <div id="progress-bar"></div>
                </div>


                <div id="manual-controls">
                    <button id="btn-replay" disabled onclick="replayAudio()">üîÅ Rejouer</button>
                    <button id="btn-play-pause" disabled onclick="togglePlayPause()">‚èØÔ∏è Pause/Play </button>
                </div>
                <button id="btn-activate-audio">üîä Activer le Son</button>
            </div>
        </div>
    </div>


    <script>
    
       
       // =========================================================
        // DONN√âES DU CIRCUIT JOUR (SANS PHOTOS)
        // =========================================================
        const CIRCUIT_JOUR_STOPS = [
            { id: 1, name: "D√©part", file: "depart_2.mp3", latitude: 6.352701574373512, longitude: 2.407548102091667, triggerRadius: 100, audioDuration: 31 },
            { id: 2, name: "Mur du Patrimoine", file: "mur_patrimoine_2.mp3", latitude: 6.350008082284632, longitude: 2.415699296052794, triggerRadius: 500, audioDuration: 31 },
            { id: 3, name: "Avenue Jean Paul II", file: "avenue_jean_paul_2.mp3", latitude: 6.352762241666526, longitude: 2.4201564243656684, triggerRadius: 500, audioDuration: 31 },
            { id: 4, name: "Place du Souvenir", file: "place_souvenir_2.mp3", latitude: 6.353965166963285, longitude: 2.404862680183919, triggerRadius: 400, audioDuration: 31 },
            { id: 5, name: "Place Bio Gu√©ra", file: "bio_guerra_2.mp3", latitude: 6.350322364770094, longitude: 2.3875428397110525, triggerRadius: 400, audioDuration: 31 },
            { id: 6, name: "H√¥tel Sofitel", file: "sofitel_2.mp3", latitude: 6.349740427997271, longitude: 2.3936832955293195, triggerRadius: 400, audioDuration: 53 },
            { id: 7, name: "Fin du Trajet", file: "fin_trajet_2.mp3", latitude: 6.352701574373512, longitude: 2.407548102091667, triggerRadius: 300, audioDuration: 41 }
        ];


        // Rempli avec les m√™mes donn√©es que le jour pour √©viter l'erreur "Circuit vide"
        // Tu peux modifier ces donn√©es plus tard pour le circuit de nuit.
        let CIRCUIT_NUIT_STOPS = [
            { id: 1, name: "D√©part Nocturne", file: "depart_2.mp3", latitude: 6.352701574373512, longitude: 2.407548102091667, triggerRadius: 100, audioDuration: 31 },
            { id: 2, name: "Mur du Patrimoine (Nuit)", file: "mur_patrimoine_2.mp3", latitude: 6.350008082284632, longitude: 2.415699296052794, triggerRadius: 500, audioDuration: 31 },
            { id: 3, name: "Avenue Jean Paul II (Nuit)", file: "avenue_jean_paul_2.mp3", latitude: 6.352762241666526, longitude: 2.4201564243656684, triggerRadius: 500, audioDuration: 31 },
            { id: 4, name: "Place du Souvenir (Nuit)", file: "place_souvenir_2.mp3", latitude: 6.353965166963285, longitude: 2.404862680183919, triggerRadius: 400, audioDuration: 31 },
            { id: 5, name: "Place Bio Gu√©ra (Nuit)", file: "bio_guerra_2.mp3", latitude: 6.350322364770094, longitude: 2.3875428397110525, triggerRadius: 400, audioDuration: 31 },
            { id: 6, name: "H√¥tel Sofitel (Nuit)", file: "sofitel_2.mp3", latitude: 6.349740427997271, longitude: 2.3936832955293195, triggerRadius: 400, audioDuration: 53 },
            { id: 7, name: "Fin du Trajet (Nuit)", file: "fin_trajet_2.mp3", latitude: 6.352701574373512, longitude: 2.407548102091667, triggerRadius: 300, audioDuration: 41 }
        ];


        // --- VARIABLES D'√âTAT ---
        let currentCircuitData = null;
        let currentStopIndex = 0;
        let isAudioPlaying = false;
        let isAudioPaused = false;
        let watchID = null;
        let simulationInterval = null;
        let isSimulationMode = false;
        let progressInterval = null;
        let wakeLock = null;


        const audioPlayer = new Audio();
        let map = null;
        let trainMarker = null;
        let stopMarker = null; 

        // --- √âL√âMENTS DOM ---
        const homeScreen = document.getElementById('home-screen');
        const trackingScreen = document.getElementById('tracking-screen');
        const gpsStatus = document.getElementById('gps-status');
        const currentStopName = document.getElementById('current-stop-name');
        const nextStopName = document.getElementById('next-stop-name');
        const audioFeedback = document.getElementById('audio-feedback');
        const distanceDisplay = document.getElementById('distance-display');
        const btnReplay = document.getElementById('btn-replay');
        const btnPlayPause = document.getElementById('btn-play-pause');
        const progressBar = document.getElementById('progress-bar');
        const btnActivateAudio = document.getElementById('btn-activate-audio'); // R√©cup√©ration du nouveau bouton


        // --- ICONES MAP ---
        const trainIcon = L.divIcon({
            className: 'custom-train-icon',
            html: '<div style="font-size:40px; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));">üöÇ</div>',
            iconSize: [50, 50],
            iconAnchor: [25, 25]
        });

function cleanupResources() {
    console.log("üßπ Nettoyage des ressources...");
    
    // 1. Nettoyer le GPS
    if (watchID) {
        navigator.geolocation.clearWatch(watchID);
        watchID = null;
        console.log("‚úì GPS arr√™t√©");
    }
    
    // 2. Nettoyer la simulation
    if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
        console.log("‚úì Simulation arr√™t√©e");
    }
    
    // 3. Nettoyer la barre de progression
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
        console.log("‚úì Barre de progression arr√™t√©e");
    }
    
    // 4. Arr√™ter l'audio
    audioPlayer.pause();
    audioPlayer.currentTime = 0;
    isAudioPlaying = false;
    isAudioPaused = false;
    progressBar.style.width = '0%';
    console.log("‚úì Audio arr√™t√©");
    
    // 5. Lib√©rer le Wake Lock
    releaseWakeLock();
    
    // 6. Cacher le bouton d'activation audio
    btnActivateAudio.style.display = 'none';
    
    console.log("‚úÖ Nettoyage termin√©");
}

        // --- D√âBLOCAGE AUDIO & VERROUILLAGE √âCRAN ---
        // Cette fonction n'est plus n√©cessaire avec le nouveau bouton d'activation
        // function unlockAudio() { }


        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    gpsStatus.classList.add('wake-lock-on');
                    console.log('Wake Lock activ√©');
                } catch (err) {
                    console.error('Erreur Wake Lock:', err.name, err.message);
                }
            }
        }


        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                    gpsStatus.classList.remove('wake-lock-on');
                    console.log('Wake Lock d√©sactiv√©');
                });
            }
        }


        // --- LOGIQUE G√âN√âRALE ---
        function startCircuit(mode) {
            cleanupResources();
            requestWakeLock();
            isSimulationMode = false;
            initCircuit(mode);
            // Assurez-vous que l'√©cran de suivi est visible avant de d√©marrer le tracking
            trackingScreen.style.display = 'flex';
            setTimeout(() => { startTracking(); }, 100);
        }


        function startSimulation() {
            cleanupResources();
            requestWakeLock();
            isSimulationMode = true;
            initCircuit('jour'); // On commence toujours la simulation avec le circuit jour par d√©faut
           
            document.getElementById('circuit-mode').textContent = "SIMULATION";
            gpsStatus.textContent = "üéÆ SIMULATION";
            gpsStatus.classList.add('simu');
            gpsStatus.classList.remove('offline');


            // Assurez-vous que l'√©cran de suivi est visible avant de d√©marrer la simulation
            trackingScreen.style.display = 'flex';
            setTimeout(() => { runSimulationLoop(); }, 1000);
        }


        function initCircuit(mode) {
            currentMode = mode;
            currentCircuitData = (mode === 'jour') ? CIRCUIT_JOUR_STOPS : CIRCUIT_NUIT_STOPS;
            if (currentCircuitData.length === 0) {
                 alert("Erreur: Circuit vide. Veuillez configurer le circuit " + mode.toUpperCase() + ".");
                 // Revenir √† l'√©cran d'accueil si le circuit est vide
                 homeScreen.style.display = 'flex';
                 trackingScreen.style.display = 'none';
                 return;
            }

            history.pushState({screen: 'tracking'}, 'Suivi', '#tracking');
    // ----------------------------------
            currentStopIndex = 0;
            homeScreen.style.display = 'none';
            trackingScreen.style.display = 'flex'; // Rendre l'√©cran de suivi visible
            document.getElementById('circuit-mode').textContent = mode.toUpperCase();
            currentStopName.textContent = "D√âBUT DE PARCOURS";
            nextStopName.textContent = currentCircuitData[currentStopIndex].name;
            audioFeedback.textContent = "En attente du premier arr√™t...";
            btnActivateAudio.style.display = 'none'; // Cacher le bouton d'activation par d√©faut
        }


      function initMap(lat, lon) {
            if (map !== null) map.remove(); // Supprimer la carte existante si elle y est
            map = L.map('map').setView([lat, lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            trainMarker = L.marker([lat, lon], { icon: trainIcon }).addTo(map);
            updateNextStopMarker();
        }


        let triggerCircle = null; // Variable pour stocker la zone de d√©clenchement

function updateNextStopMarker() {
    // 1. Suppression des anciens √©l√©ments (Marqueur + Cercle de zone)
    if (stopMarker) {
        map.removeLayer(stopMarker);
        stopMarker = null;
    }
    if (triggerCircle) {
        map.removeLayer(triggerCircle);
        triggerCircle = null;
    }

    const nextStop = currentCircuitData[currentStopIndex];
    
    if (nextStop) {
        // 2. Ajout de la zone de d√©clenchement (Le grand cercle bleu transparent)
        // On utilise L.circle car son 'radius' est en m√®tres r√©els sur la carte
        triggerCircle = L.circle([nextStop.latitude, nextStop.longitude], {
            radius: nextStop.triggerRadius, // Utilise le rayon de votre circuit (ex: 50m, 100m)
            color: '#E67E22',      // Couleur du contour
            fillColor: '#E67E22',  // Couleur de remplissage
            fillOpacity: 0.2,     // Tr√®s transparent pour ne pas masquer la carte
            weight: 1.5,             // √âpaisseur du trait de bordure
            dashArray: '5, 10'      // Optionnel : rend le bord en pointill√©s
        }).addTo(map);

        // 3. Votre point rouge actuel (Le rep√®re visuel au centre)
        stopMarker = L.circleMarker([nextStop.latitude, nextStop.longitude], {
            radius: 8,
            fillColor: "#CC0000",
            color: "white",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map);
    }
}


        function updateMap(lat, lon) {
            const newLatLng = new L.LatLng(lat, lon);
            if (trainMarker) trainMarker.setLatLng(newLatLng);
            if (map) map.setView(newLatLng, map.getZoom());
        }


        // --- BARRE DE PROGRESSION ---
        function startProgressTracking() {
            if (progressInterval) clearInterval(progressInterval); // S'assurer qu'un seul intervalle est actif
            progressInterval = setInterval(() => {
                const duration = audioPlayer.duration;
                const currentTime = audioPlayer.currentTime;
                if (duration > 0 && currentTime >= 0) {
                    const percentage = (currentTime / duration) * 100;
                    progressBar.style.width = percentage + '%';
                }
            }, 100);
        }


        function stopProgressTracking() {
            clearInterval(progressInterval);
            progressInterval = null; // Vider l'identifiant de l'intervalle
            progressBar.style.width = '0%';
        }


        // --- SUIVI GPS ---
        function startTracking() {
            if ('geolocation' in navigator) {
                gpsStatus.textContent = "üü° RECHERCHE...";
                watchID = navigator.geolocation.watchPosition(
                    (position) => {
                        gpsStatus.textContent = "üü¢ GPS ONLINE";
                        gpsStatus.classList.remove('offline');
                        if (map === null) initMap(position.coords.latitude, position.coords.longitude);
                        else updateMap(position.coords.latitude, position.coords.longitude); // Mise √† jour de la carte ici
                        checkStopTrigger(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        gpsStatus.textContent = "üî¥ GPS OFF";
                        gpsStatus.classList.add('offline');
                        audioFeedback.textContent = "Erreur GPS : " + error.message + ". Utilisation des coordonn√©es par d√©faut.";
                        if (map === null) initMap(6.366, 2.448); // Coordonn√©es par d√©faut si initMap n'a jamais √©t√© appel√©
                        else updateMap(6.366, 2.448); // Si la carte existe, mettez √† jour la position du train
                        checkStopTrigger(6.366, 2.448); // V√©rifier le d√©clenchement m√™me avec des coordonn√©es par d√©faut
                        console.error("Erreur de g√©olocalisation:", error);
                    },
                    { enableHighAccuracy: true, maximumAge: 2000 }
                );
            } else {
                alert("GPS non support√© par ce navigateur. Lancement en mode simulation.");
                startSimulation(); // Fallback vers la simulation si le GPS n'est pas support√©
            }
        }


        function runSimulationLoop() {
            // Initialisation de la simulation plus proche du premier arr√™t du CIRCUIT_JOUR_STOPS
            let simLat = CIRCUIT_JOUR_STOPS[0].latitude + 0.001;
            let simLon = CIRCUIT_JOUR_STOPS[0].longitude + 0.001;
           
            if (map === null) initMap(simLat, simLon); // Initialiser la carte si elle ne l'est pas
            const stepSize = 0.00005; // Ajuste cette valeur pour changer la vitesse de la simulation


            simulationInterval = setInterval(() => {
                if (!currentCircuitData || !currentCircuitData[currentStopIndex]) {
                    clearInterval(simulationInterval);
                    simulationInterval = null; // Vider l'identifiant de l'intervalle
                    releaseWakeLock(); // Rel√¢cher le wakelock en fin de simulation
                    audioFeedback.textContent = "Simulation termin√©e.";
                    return;
                }


                const target = currentCircuitData[currentStopIndex];
                const dLat = target.latitude - simLat;
                const dLon = target.longitude - simLon;
                const dist = Math.sqrt(dLat*dLat + dLon*dLon);


                if (dist > 0.0001) { // Si la distance est encore significative
                    simLat += (dLat / dist) * stepSize;
                    simLon += (dLon / dist) * stepSize;
                } else {
                    // Si tr√®s proche de la cible, "coller" √† la cible pour √©viter de la d√©passer
                    simLat = target.latitude;
                    simLon = target.longitude;
                }
                updateMap(simLat, simLon);
                checkStopTrigger(simLat, simLon);
            }, 100);
        }


        // --- COEUR DU SYST√àME ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }


        function checkStopTrigger(lat, lon) {
            const nextStop = currentCircuitData[currentStopIndex];
            if (!nextStop) {
                currentStopName.textContent = "TERMINUS";
                nextStopName.textContent = "---";
                distanceDisplay.textContent = "0 m";
                btnReplay.disabled = true;
                btnPlayPause.disabled = true;
                if (watchID) navigator.geolocation.clearWatch(watchID);
                if (simulationInterval) clearInterval(simulationInterval); // Nettoyer l'intervalle de simulation
                stopProgressTracking(); // Assurer que la barre de progression s'arr√™te
                releaseWakeLock();
                return;
            }
            const dist = calculateDistance(lat, lon, nextStop.latitude, nextStop.longitude);
            distanceDisplay.textContent = Math.round(dist) + " m";


            // Mettre √† jour l'√©tat des boutons manuels en fonction de l'√©tat actuel de l'audio
            if (isAudioPlaying || isAudioPaused) {
                btnReplay.disabled = false;
                btnPlayPause.disabled = false;
                if (isAudioPaused) {
                    btnPlayPause.textContent = "‚ñ∂Ô∏è Play";
                    btnPlayPause.classList.add('paused');
                } else {
                    btnPlayPause.textContent = "‚è∏Ô∏è Pause";
                    btnPlayPause.classList.remove('paused');
                }
            } else {
                btnReplay.disabled = true;
                btnPlayPause.disabled = true;
                btnPlayPause.textContent = "‚èØÔ∏è Pause/Play";
                btnPlayPause.classList.remove('paused');
            }


            // D√©clenchement de l'audio si proche de l'arr√™t ET qu'aucun audio n'est d√©j√† en cours ou en pause
            if (dist <= nextStop.triggerRadius && !isAudioPlaying && !isAudioPaused) {
                playAudio(nextStop);
            }
        }


        function playAudio(stop) {
            audioPlayer.src = stop.file ? ('assets/audio/' + stop.file) : '';
            currentStopName.textContent = stop.name;
           
            isAudioPlaying = true;
            isAudioPaused = false;
            btnPlayPause.textContent = "‚è∏Ô∏è Pause";
            btnPlayPause.classList.remove('paused');
            btnReplay.disabled = false;
            btnPlayPause.disabled = false;


            // Reset progress bar on new audio play
            progressBar.style.width = '0%';
            startProgressTracking();


            var playPromise = audioPlayer.play();


            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // Audio started successfully
                    audioFeedback.textContent = `‚ñ∂Ô∏è LECTURE : ${stop.name}`;
                    btnActivateAudio.style.display = 'none'; // Cacher le bouton d'activation
                }).catch(error => {
                    console.error("Auto-play bloqu√© :", error);
                    isAudioPlaying = false; // Ne pas consid√©rer comme jouant si bloqu√©
                    isAudioPaused = false; // Ni en pause
                    audioFeedback.textContent = "‚ö†Ô∏è Le son est bloqu√©. Cliquez sur le bouton ci-dessous pour activer.";
                   
                    // Afficher un bouton sp√©cifique pour activer l'audio
                    btnActivateAudio.style.display = 'block';
                    btnActivateAudio.onclick = function() {
                        audioPlayer.play().then(() => {
                            isAudioPlaying = true;
                            isAudioPaused = false;
                            audioFeedback.textContent = `‚ñ∂Ô∏è LECTURE : ${stop.name}`;
                            btnPlayPause.textContent = "‚è∏Ô∏è Pause";
                            btnPlayPause.classList.remove('paused');
                            btnReplay.disabled = false;
                            btnPlayPause.disabled = false;
                            startProgressTracking();
                            btnActivateAudio.style.display = 'none'; // Cacher le bouton une fois activ√©
                        }).catch(err => {
                            console.error("√âchec de l'activation manuelle :", err);
                            audioFeedback.textContent = "√âchec de l'activation. R√©essayez.";
                        });
                    };


                    // D√©sactiver les contr√¥les de base tant que l'audio n'est pas activ√©
                    btnReplay.disabled = true;
                    btnPlayPause.disabled = true;
                    btnPlayPause.textContent = "‚èØÔ∏è Pause/Play";
                    btnPlayPause.classList.remove('paused');
                    stopProgressTracking(); // Arr√™ter la progression si l'audio est bloqu√©
                });
            }


            audioPlayer.onended = () => {
                isAudioPlaying = false;
                isAudioPaused = false;
                currentStopIndex++;
                updateNextStopMarker();
                stopProgressTracking();
               
                if (currentCircuitData && currentCircuitData[currentStopIndex]) {
                    nextStopName.textContent = currentCircuitData[currentStopIndex].name;
                    audioFeedback.textContent = "En route vers le prochain arr√™t...";
                } else {
                    nextStopName.textContent = "FIN";
                    audioFeedback.textContent = "Circuit termin√©. Bonne journ√©e !";
                    releaseWakeLock();
                }
                btnReplay.disabled = true;
                btnPlayPause.disabled = true;
                btnPlayPause.textContent = "‚èØÔ∏è Pause/Play";
                btnPlayPause.classList.remove('paused');
            };
        }


        function replayAudio() {
            const stopToReplay = currentCircuitData[currentStopIndex];


            if (stopToReplay) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isAudioPaused = false;
                playAudio(stopToReplay);
                audioFeedback.textContent = `üîÅ REPLAY : ${stopToReplay.name}`;
                // Les √©tats des boutons seront mis √† jour par playAudio()
            } else {
                console.warn("Aucun arr√™t √† rejouer.");
            }
        }


        function togglePlayPause() {
    if (isAudioPlaying) {
        audioPlayer.pause();
        isAudioPlaying = false;
        isAudioPaused = true;
        audioFeedback.textContent = `‚è∏Ô∏è PAUSE : ${currentCircuitData[currentStopIndex].name}`;
        btnPlayPause.textContent = "‚ñ∂Ô∏è Play";
        btnPlayPause.classList.add('paused');
        stopProgressTracking();
    } else if (isAudioPaused) {
        audioPlayer.play();
        isAudioPlaying = true;
        isAudioPaused = false;
        audioFeedback.textContent = `‚ñ∂Ô∏è LECTURE : ${currentCircuitData[currentStopIndex].name}`;
        btnPlayPause.textContent = "‚è∏Ô∏è Pause";
        btnPlayPause.classList.remove('paused');
        startProgressTracking();
    }
    btnReplay.disabled = false;
    btnPlayPause.disabled = false;
}


// --- GESTION DU PANNEAU TOGGLE ---
function togglePanel() {
    const panel = document.getElementById('info-panel');
    const icon = document.getElementById('toggle-icon');
   
    // On v√©rifie la position actuelle du panneau
    // Note : on compare avec la valeur exacte du CSS
    if (panel.style.transform === 'translateY(0%)') {
        // FERMER : on le renvoie vers le bas (70% de sa hauteur)
        panel.style.transform = 'translateY(70%)';
        icon.textContent = "‚¨ÜÔ∏è";
    } else {
        // OUVRIR : on le remonte √† sa position initiale
        panel.style.transform = 'translateY(0%)';
        icon.textContent = "‚¨áÔ∏è";
    }
}




   // --- NOUVELLES FONCTIONS POUR LA NAVIGATION ---


function showHomeScreen() {
    cleanupResources();
    if (triggerCircle) { map.removeLayer(triggerCircle); triggerCircle = null; }
    trackingScreen.style.display = 'none';
    homeScreen.style.display = 'flex';
    // Assurez-vous d'arr√™ter tout suivi/simulation si on revient √† l'accueil
    if (watchID) navigator.geolocation.clearWatch(watchID);
    if (simulationInterval) clearInterval(simulationInterval);
    releaseWakeLock(); // Lib√®re le wakelock
    stopProgressTracking(); // Arr√™te la barre de progression
    audioPlayer.pause(); // Met en pause l'audio
    isAudioPlaying = false;
    isAudioPaused = false;
    btnActivateAudio.style.display = 'none'; // Cacher le bouton d'activation
}


function showTrackingScreen() {
    homeScreen.style.display = 'none';
    trackingScreen.style.display = 'flex';
}


// G√©rer le clic sur le nouveau bouton Retour
document.getElementById('btn-back-home').addEventListener('click', () => {
    // Utiliser history.back() pour un retour propre dans l'historique g√©r√©
    history.back();
});








// --- GESTION DE L'√âV√âNEMENT POPSTATE (bouton retour du navigateur) ---
window.addEventListener('popstate', (event) => {
    // Si l'√©tat actuel est l'√©cran d'accueil (ou l'√©tat initial),
    // ou si l'√©v√©nement popstate revient √† l'URL sans #tracking
    if (event.state === null || event.state.screen !== 'tracking') {
        showHomeScreen();
    } else {
        // Cela devrait techniquement ne pas arriver si on utilise bien pushState
        // mais c'est une s√©curit√©.
        showTrackingScreen();
    }
});


// G√©rer le cas o√π l'utilisateur arrive directement sur l'URL #tracking (pourrait √™tre utile)
// if (window.location.hash === '#tracking') {
//     showTrackingScreen();
//     // Potentiellement recharger le circuit en fonction de l'√©tat (plus complexe)
// } else {
//     showHomeScreen(); // Assure que l'accueil est affich√© par d√©faut
// }


   </script>






   <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker enregistr√© !', reg))
            .catch(err => console.log('Erreur SW :', err));
        });
      }
    </script>


</body>
</html>
